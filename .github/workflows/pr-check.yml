name: PR Check - API

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'backend/**'

jobs:
  test-and-build:
    name: Test and Build Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install dependencies
        working-directory: ./backend
        run: go mod download

      - name: Run tests
        working-directory: ./backend
        run: go test -v ./...

      - name: Build check
        working-directory: ./backend
        run: |
          docker build -t test-build .

      - name: Security scan
        working-directory: ./backend
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

      - name: Go mod tidy check
        working-directory: ./backend
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum

      - name: Go format check
        working-directory: ./backend
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "Go files must be formatted with gofmt:"
            gofmt -s -l .
            exit 1
          fi

      - name: Comment PR
        uses: actions/github-script@v6
        if: always()
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('ğŸ” API Build Check')
            );
            
            const status = '${{ job.status }}';
            const commentBody = status === 'success' 
              ? 'ğŸ” API Build Check\n\nâœ… ãƒ“ãƒ«ãƒ‰ã¨ãƒ†ã‚¹ãƒˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼\n\n- âœ… ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ\n- âœ… Dockerãƒ“ãƒ«ãƒ‰\n- âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³\n- âœ… ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯'
              : 'ğŸ” API Build Check\n\nâŒ ãƒ“ãƒ«ãƒ‰ã¾ãŸã¯ãƒ†ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\nè©³ç´°ã¯Actionsãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
            
            if (botComment) {
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
            }